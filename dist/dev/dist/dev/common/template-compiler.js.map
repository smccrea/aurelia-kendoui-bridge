{"version":3,"sources":["common/template-compiler.js"],"names":["inject","TemplatingEngine","ViewResources","createOverrideContext","Util","TemplateCompiler","templatingEngine","util","isInitialized","initialize","window","kendo","_this","ui","Widget","prototype","angular","_event","_args","handleTemplateEvents","mobile","widget","$parent","container","$angular","options","_$parent","_$container","args","elements","data","scopeFrom","compile","cleanup","i","element","ctx","undefined","_data","dataItem","aggregate","isObject","jQuery","each","index","elem","enhanceView","length","view","querySelectorAll","childContainer","createChild","resources","get","enhance","bindingContext","overrideContext","bind","attached","cleanupView","detached","unbind"],"mappings":"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","file":"common/template-compiler.js","sourceRoot":"/source/","sourcesContent":["import {inject} from 'aurelia-dependency-injection';\nimport {TemplatingEngine, ViewResources} from 'aurelia-templating';\nimport {createOverrideContext} from 'aurelia-binding';\nimport {Util} from './util';\n\n/**\n* An adaptor which uses Aurelia's enhance capability to\n* compile any template Kendo wants to have compiled\n*/\n@inject(TemplatingEngine, Util)\nexport class TemplateCompiler {\n  /**\n  * We don't need to initialize the TemplateCompiler every time a Kendo controls\n  * is initialized\n  */\n  isInitialized = false;\n\n  constructor(templatingEngine, util) {\n    this.templatingEngine = templatingEngine;\n    this.util = util;\n  }\n\n  /**\n  * Initialize the template compiler and\n  * patch the angular property to retrieve compilation requests\n  * from Kendo controls\n  * @param $parent The overrideContext to use when a template gets compiled\n  */\n  initialize() {\n    if (this.isInitialized) return;\n\n    if (!window.kendo) return;\n\n    // all controls derive from kendo.ui.Widget\n    // override the angular property on these objects, and point it towards handleTemplateEvents\n    let _this = this;\n    kendo.ui.Widget.prototype.angular = function(_event, _args) {\n      _this.handleTemplateEvents(this, _event, _args);\n    };\n    kendo.mobile.ui.Widget.prototype.angular = function(_event, _args) {\n      _this.handleTemplateEvents(this, _event, _args);\n    };\n\n    this.isInitialized = true;\n  }\n\n  /**\n  * Gets called by Kendo, and filters out compile and cleanup events,\n  * then calls the compile or cleanup function with the needed arguments\n  * @param _event Events like 'compile' or 'cleanup'\n  * @param _args optional array of dataitems\n  */\n  handleTemplateEvents(widget, _event: string, _args?) {\n    if (_event !== 'compile' && _event !== 'cleanup') return;\n\n    // pull the parent context of the widget, or of the options\n    // in some cases, templates are compiled when a Kendo control's constructor is called\n    // in these cases we get the parent context of the options instead of the\n    // widget\n    let $parent;\n    let container;\n    let $angular = widget.$angular || widget.options.$angular;\n\n    if ($angular) {\n      $parent = $angular[0]._$parent;\n      container = $angular[0]._$container;\n    }\n\n    if (!$parent) return;\n\n    let args = _args();\n    let elements = args.elements; // extract elements from the args\n    let data = args.data; // extract the dataitems from the args\n    let scopeFrom = args.scopeFrom;\n\n    switch (_event) {\n    case 'compile':\n      // we need to pass elements and data to compile\n      // so that Aurelia can enhance this elements with the correct\n      // binding context\n      this.compile($parent, elements, data, scopeFrom, container);\n      break;\n\n    case 'cleanup':\n      // we don't care about dataitems when we do the cleanup\n      // so we just pass in the DOM elements\n      this.cleanup(elements);\n      break;\n\n    default:\n      break;\n    }\n  }\n\n  /**\n  * loops through each element, and find the matching dataitem\n  * and calls enhanceView(element, dataItem) for each element there is\n  * @param elements an array of Elements or a kendo.jQuery selector\n  * @param data optionally an array of dataitems\n  */\n  compile($parent, elements, data, scopeFrom, container) {\n    for (let i = 0; i < elements.length; i++) {\n      let element = elements[i];\n      let ctx = undefined;\n\n      if (data && data[i]) {\n        let _data = data[i];\n        let dataItem = _data.dataItem || _data.aggregate || _data;\n\n        if (!this.util.isObject(dataItem)) {\n          ctx = {\n            dataItem: dataItem\n          };\n        } else {\n          ctx = dataItem;\n        }\n      } else if (scopeFrom) {\n        ctx = scopeFrom;\n      }\n\n      if (element instanceof kendo.jQuery) {\n        element.each((index, elem) => this.enhanceView($parent, elem, ctx, container));\n      } else {\n        this.enhanceView($parent, element, ctx, container);\n      }\n    }\n  }\n\n  /**\n  * uses the enhance function of Aurelia's TemplatingEngine\n  * to \"compile\" existing DOM elements\n  * @param element The Element to compile\n  * @param ctx The dataitem (context) to compile the Element with\n  */\n  enhanceView($parent, element, ctx, container) {\n    let view = kendo.jQuery(element).data('viewInstance');\n\n    kendo.jQuery(element).data('$$kendoScope', ctx);\n\n    // check necessary due to https://github.com/aurelia-ui-toolkits/aurelia-kendoui-bridge/issues/308\n    if (element.querySelectorAll('.au-target').length === 0) {\n      if (container) {\n        let childContainer = container.createChild();\n        let resources = container.get(ViewResources);\n\n        view = this.templatingEngine.enhance({\n          bindingContext: ctx,\n          overrideContext: createOverrideContext(ctx, $parent),\n          container: childContainer,\n          element: element,\n          resources: resources\n        });\n      } else {\n        view = this.templatingEngine.enhance({\n          bindingContext: ctx,\n          overrideContext: createOverrideContext(ctx, $parent),\n          element: element\n        });\n      }\n\n      // when we do cleanup, we need to get the view instance\n      // so we can call detached/unbind\n      // so we store this view instance in the DOM element using kendo.jQuery.data\n      kendo.jQuery(element).data('viewInstance', view);\n    } else {\n      view.bind(ctx, createOverrideContext(ctx, $parent));\n    }\n\n    view.attached(); // attach it to the DOM\n  }\n\n  /**\n  * loops through each element kendo asks us to clean up\n  * calls cleanupView() for each element\n  * @param element An array of elements\n  */\n  cleanup(elements) {\n    if (!elements) return;\n\n    for (let i = 0; i < elements.length; i++) {\n      let element = elements[i];\n      this.cleanupView(element);\n    }\n  }\n\n  /**\n  * cleans up the view kendo has asked us to clean up\n  */\n  cleanupView(element) {\n    // extract Aurelia's View instance from the element\n    // we stored this in the enhanceView function\n    let view = kendo.jQuery(element).data('viewInstance');\n    if (!view) return;\n\n    // unbind and detach the view\n    view.detached();\n    view.unbind();\n  }\n}\n"]}